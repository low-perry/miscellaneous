<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Pianos | My Super Shop</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f9fafb;
        color: #1f2937;
        margin: 0;
      }
      .container {
        width: 100%;
        max-width: 1280px;
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
      }
      header {
        background-color: #ffffff;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        padding: 1rem 0;
      }
      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
      }
      main {
        padding-top: 2rem;
        padding-bottom: 3rem;
      }
      footer {
        background-color: #ffffff;
        margin-top: 4rem;
        padding: 2rem 0;
        text-align: center;
        color: #6b7280;
        border-top: 1px solid #e5e7eb;
      }
      .search-layout {
        display: flex;
        gap: 2rem;
      }
      .search-main-content {
        flex: 3;
      }
      .search-sidebar {
        flex: 1;
      }
      .results-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .product-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background-color: #fff;
        overflow: hidden;
        transition: box-shadow 0.2s;
        display: flex;
        flex-direction: column;
      }
      .product-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .product-card a.product-link {
        text-decoration: none;
        color: inherit;
      }
      .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background-color: #f3f4f6;
      }
      .product-info {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }
      .product-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
      }
      .product-brand {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0 0 0.5rem 0;
      }
      .product-price-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
      }
      .product-price {
        font-size: 1.125rem;
        font-weight: 700;
      }
      .variant-swatches {
        display: flex;
        gap: 0.5rem;
        margin: 0.75rem 0;
      }
      .variant-swatch {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .variant-swatch:hover {
        transform: scale(1.1);
      }
      .facet-block {
        margin-bottom: 1.5rem;
      }
      .facet-title {
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-transform: capitalize;
      }
      .facet-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .facet-item {
        margin-bottom: 0.5rem;
      }
      .facet-item label {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .facet-item input {
        margin-right: 0.5rem;
      }
      .facet-item .count {
        margin-left: auto;
        color: #6b7280;
        font-size: 0.875rem;
      }
      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 2rem;
      }
      .pagination-button, .pagination-page {
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .pagination-button:hover, .pagination-page:hover {
        background-color: #f3f4f6;
      }
      .pagination-page.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
        font-weight: 600;
      }
      .pagination-button:disabled {
        color: #9ca3af;
        cursor: not-allowed;
        background-color: #f9fafb;
      }
      .breadcrumbs {
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
        color: #6b7280;
      }
      .breadcrumb-item {
        text-decoration: none;
        color: #3b82f6;
        transition: color 0.2s;
      }
      .breadcrumb-item:hover {
        color: #1d4ed8;
      }
      .breadcrumb-separator {
        margin: 0 0.5rem;
        color: #9ca3af;
      }
      .breadcrumb-current {
        font-weight: 500;
        color: #1f2937;
      }
    </style>
</head>
<body>
    <header>
      <div class="container header-content">
        <h1>My Super Shop</h1>
      </div>
    </header>

    <main class="container">
      <nav id="breadcrumbs-container" class="breadcrumbs"></nav>
      <div class="search-layout">
        <aside class="search-sidebar" id="facets-container"></aside>
        <div class="search-main-content">
          <h2 id="results-heading"></h2>
          <div class="results-grid" id="results-container"></div>
          <div id="pagination-container"></div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        &copy; 2025 My Super Shop. Powered by Luigi's Box.
      </div>
    </footer>

    <script>
      // --- CONFIGURATION ---
      const TRACKER_ID = "179075-204259";
      const API_ENDPOINT = "https://live.luigisbox.com/search";
      const ANALYTICS_API_URL = "https://api.luigisbox.com/";
      const RESULTS_PER_PAGE = 9;
      // In a real application, this should be a persistent ID stored in a cookie or localStorage
      const CLIENT_ID = Math.floor(Math.random() * 1e18); 
      // This defines the category page we are on
      const CURRENT_CATEGORY_PATH = "Musicians||Keys||Digital Pianos";

      // --- DOM ELEMENTS ---
      const resultsContainer = document.getElementById("results-container");
      const facetsContainer = document.getElementById("facets-container");
      const resultsHeading = document.getElementById("results-heading");
      const paginationContainer = document.getElementById("pagination-container");
      const breadcrumbsContainer = document.getElementById("breadcrumbs-container");

      // --- STATE MANAGEMENT ---
      let activeFilters = {};
      let currentPage = 1;

      // --- API CALL ---
      async function getProductListing(categoryPath, filters = {}, page = 1) {
        const params = {
          tracker_id: TRACKER_ID,
          'f[]': [
            `all_categories_path:${categoryPath}`,
            'type:product'
          ],
          plp: 'all_categories_path',
          facets: 'brand,category,price_amount',
          hit_fields: 'title,url,price_amount,image_link,brand,nested,color_code,color,id',
          size: RESULTS_PER_PAGE,
          page: page,
        };

        for (const key in filters) {
          filters[key].forEach(value => {
            params['f[]'].push(`${key}:${value}`);
          });
        }

        try {
          const response = await axios.get(API_ENDPOINT, { params });
          const data = response.data;
          
          currentPage = page;
          renderResults(data.results);
          renderFacets(data.results.facets);
          renderPagination(data.results.total_hits);
          renderBreadcrumbs(CURRENT_CATEGORY_PATH);
          updateURL(filters, page);

          // Track the list view event for analytics
          trackListView(data.results.hits, page);

        } catch (error) {
          console.error("Error fetching product listing:", error);
          resultsContainer.innerHTML = "<p>Sorry, there was an error fetching products for this category.</p>";
        }
      }

      // --- RENDERING FUNCTIONS ---
      function renderBreadcrumbs(pathString) {
          const pathParts = pathString.split('||');
          let accumulatedPath = '';
          const breadcrumbHTML = pathParts.map((part, index) => {
              accumulatedPath += (index > 0 ? '||' : '') + part;
              if (index === pathParts.length - 1) {
                  return `<span class="breadcrumb-current">${part}</span>`;
              } else {
                  // In a real multi-page app, this would link to the actual category page URL
                  const categoryUrl = `?category=${encodeURIComponent(accumulatedPath)}`;
                  return `<a href="${categoryUrl}" class="breadcrumb-item">${part}</a><span class="breadcrumb-separator">/</span>`;
              }
          }).join('');
          breadcrumbsContainer.innerHTML = `<a href="/" class="breadcrumb-item">Home</a><span class="breadcrumb-separator">/</span>` + breadcrumbHTML;
      }

      function renderResults(resultsData) {
        const categoryName = CURRENT_CATEGORY_PATH.split('||').pop();
        resultsHeading.textContent = `Showing ${resultsData.total_hits} results for "${categoryName}"`;

        if (resultsData.hits.length === 0) {
          resultsContainer.innerHTML = "<p>No products found in this category.</p>";
          return;
        }

        resultsContainer.innerHTML = resultsData.hits.map(result => {
          const { url, attributes, nested } = result;
          const imageUrl = attributes.image_link || "https://placehold.co/400x400/eee/ccc?text=No+Image";
          const title = attributes.title || "No Title Available";
          const brand = attributes.brand ? attributes.brand[0] : "";
          const price = attributes.price_amount ? `${attributes.price_amount} EUR` : "";
          const productId = attributes.id ? attributes.id[0] : "";

          let variantSwatches = '';
          const variants = nested?.filter(v => v.type === 'variant') || [];
          if(variants.length > 0) {
              const uniqueColors = new Map();
              variants.forEach(variant => {
                  const colorName = variant.attributes.color?.[0];
                  if(colorName){
                      const normalizedColorName = colorName.toLowerCase();
                      if(!uniqueColors.has(normalizedColorName)){
                          uniqueColors.set(normalizedColorName, {
                              colorCode: variant.attributes.color_code?.[0] || '#ccc',
                              image: variant.attributes.image_link || imageUrl
                          });
                      }
                  }
              });

              if(uniqueColors.size > 0){
                  variantSwatches = '<div class="variant-swatches">';
                  uniqueColors.forEach(data => {
                      variantSwatches += `<div class="variant-swatch" style="background-color: ${data.colorCode};" data-image="${data.image}"></div>`;
                  });
                  variantSwatches += '</div>';
              }
          }

          return `
            <div class="product-card" data-main-image="${imageUrl}">
              <a href="${url}" target="_blank" class="product-link" data-product-id="${productId}">
                <img src="${imageUrl}" alt="${title}" class="product-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/eee/ccc?text=No+Image';">
              </a>
              <div class="product-info">
                <h3 class="product-title">${title}</h3>
                <p class="product-brand">${brand}</p>
                ${variantSwatches}
                <div class="product-price-section">
                  <div class="product-price">${price}</div>
                </div>
              </div>
            </div>`;
        }).join('');
      }
      
      function renderFacets(facetsData) { /* Omitted for brevity, assumed to be the same as previous examples */ }
      function renderPagination(totalHits) { /* Omitted for brevity, assumed to be the same as previous examples */ }

      // --- URL MANAGEMENT ---
      function updateURL(filters, page) {
        const urlParams = new URLSearchParams();
        urlParams.set('category', CURRENT_CATEGORY_PATH);
        if (page > 1) urlParams.set("page", page);
        for (const key in filters) {
          filters[key].forEach(value => {
            urlParams.append('f[]', `${key}:${value}`);
          });
        }
        const newRelativePath = `?${urlParams.toString()}`;
        if (window.location.search !== newRelativePath) {
          history.pushState({ filters, page }, "", newRelativePath);
        }
      }

      // --- ANALYTICS TRACKING ---
      async function sendAnalyticsEvent(payload) {
          try {
              await axios.post(ANALYTICS_API_URL, payload);
              console.log('Analytics event sent:', payload);
          } catch (error) {
              console.error('Failed to send analytics event:', error);
          }
      }

      function trackListView(hits, page) {
          if (!hits || hits.length === 0) return;
          const listViewPayload = {
              id: crypto.randomUUID(),
              type: "event",
              tracker_id: TRACKER_ID,
              client_id: CLIENT_ID,
              lists: {
                  "Product Listing Page": {
                      items: hits.map((hit, index) => ({
                          title: hit.attributes.title,
                          url: hit.url,
                          position: (page - 1) * RESULTS_PER_PAGE + index + 1
                      }))
                  }
              }
          };
          sendAnalyticsEvent(listViewPayload);
      }
      // Other analytics functions (trackClickEvent, etc.) would be here

      // --- EVENT LISTENERS ---
      document.addEventListener('DOMContentLoaded', () => {
          // Initial load of the product listing
          getProductListing(CURRENT_CATEGORY_PATH, activeFilters, currentPage);
      });

      // Event listeners for facets, pagination, and variant hovers would be here
    </script>
</body>
</html>